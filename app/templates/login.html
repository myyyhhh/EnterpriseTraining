<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能助手 - 用户切换功能</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../static/CSS/index.css">
    <style>
        /* 添加基本的错误消息样式 */
        .error-message {
            color: #d32f2f;
            /* 红色 */
            background-color: #ffcdd2;
            /* 浅红色背景 */
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-message i {
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div class="login-container" id="loginContainer">
        <form class="login-form" method="POST" action="/login">
            <h2>登录系统</h2>

            <!-- 错误消息显示区域 -->
            {% if error %}
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i> {{ error }}
            </div>
            {% endif %}

            <div class="form-group">
                <label for="inputUsername">用户名</label>
                <input type="text" id="inputUsername" name="username" placeholder="输入用户名" required>
            </div>
            <div class="form-group">
                <label for="inputPassword">密码</label>
                <input type="password" id="inputPassword" name="password" placeholder="输入密码" required>
            </div>
            <button type="submit" class="btn btn-login">登录</button>
        </form>
    </div>

    <script>
        // 1. 选择登录表单并添加提交事件监听器
        document.querySelector('.login-form').addEventListener('submit', async function (e) {
            // 阻止表单的默认提交行为（页面刷新）
            e.preventDefault();

            // 2. 获取表单元素和表单数据
            const form = e.target; // 当前提交的表单元素
            const formData = new FormData(form); // 创建FormData对象收集表单数据

            try {
                // 3. 使用Fetch API发送异步POST请求
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new URLSearchParams(formData) // 将表单数据转换为URL编码格式
                });

                // 4. 检查响应是否为重定向（登录成功）
                if (response.redirected) {
                    // 重定向表示登录成功，跳转到目标页面
                    window.location.href = response.url;
                } else {
                    // 5. 处理非重定向响应（登录失败）
                    // 获取HTML响应内容
                    const html = await response.text();

                    // 创建临时容器解析HTML
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = html;

                    // 获取新的登录表单容器
                    const newLoginContainer = tempContainer.querySelector('#loginContainer');

                    if (newLoginContainer) {
                        // 6. 更新页面内容
                        // 替换现有登录容器内容
                        document.getElementById('loginContainer').innerHTML = newLoginContainer.innerHTML;

                        // 7. 重新绑定事件处理程序
                        document.querySelector('.login-form').addEventListener('submit', arguments.callee);
                    }
                }
            } catch (error) {
                // 8. 处理网络错误
                const errorElement = document.querySelector('.error-message');
                if (errorElement) {
                    // 如果已有错误元素，更新其内容
                    errorElement.textContent = '请求失败: ' + error.message;
                    errorElement.style.display = 'block';
                } else {
                    // 9. 创建新的错误消息元素
                    const newErrorElement = document.createElement('div');
                    newErrorElement.className = 'error-message';
                    newErrorElement.textContent = '请求失败: ' + error.message;

                    // 插入到表单顶部
                    const form = document.querySelector('.login-form');
                    form.insertBefore(newErrorElement, form.firstChild);
                }
            }
        });
    </script>
</body>

</html>